#- ============================================================================
#- Motor record init
#- ============================================================================

{%- set axisFlags = 6 %}
{%- if axis.autoEnable is defined %}
    {%- if (axis.autoEnable.enableTimeout is defined) or (axis.autoEnable.disableTime is defined) %}
         #- turn of motor record auto enable (bit 1 = 0)
         {%- set axisFlags = 4 %}
    {%- endif %}

    {%- if (axis.autoEnable.atStartup is defined) and (axis.autoEnable.atStartup == true) %}
       #-  Set enable at axis create bit (bit 1 in axisFlags)
       {%- set axisFlags = axisFlags + 1 %}
    {%- endif %}
{%- endif %}

#-  Default to sync softlimits
{%- set syncEcmcMRSofLim = 0 %}
{%- if (epics is defined) and (epics.motorRecord is defined) and (epics.motorRecord.syncSoftLimits is defined) %}
    {% if (epics.motorRecord.syncSoftLimits == true) %}
        {% set syncEcmcMRSofLim = 1 %}
    {%- endif %}
{%- endif %}

{%- if (epics is defined) and (epics.name is defined) %}
    {%- set epicsName = epics.name %}
{%- else %}
    {%- set epicsName = "axis" %}
{%- endif %}

${ECMC_MR_MODULE="ecmcMotorRecord"}CreateAxis(${ECMC_MOTOR_PORT}, ${ECMC_AXIS_NO}, ${ECMC_AXIS_FLAGS={{ axisFlags }}}, "syncSoftLims={{ syncEcmcMRSofLim }};{{ axis.parameters|default("") }}")
epicsEnvUnset(ECMC_AXIS_FLAGS)

{# jog velocity #}
{%- if (trajectory.jog is defined) and (trajectory.jog.velocity is defined) %}
    {%- set jogVelocity = trajectory.jog.velocity %}
{%- else %}
    {%- set jogVelocity = trajectory.axis.velocity / 10.0 %}
{%- endif %}

{# jog acceleration #}
{%- if (trajectory.jog is defined) and (trajectory.jog.acceleration is defined) %}
    {%- set jogAcceleration = trajectory.jog.acceleration %}
{%- else %}
    {%- set jogAcceleration = trajectory.axis.acceleration %}
{%- endif %}

{%- if monitoring is defined %}
    {%- if monitoring.target is defined %}
        {%- set rdbd = monitoring.target.tolerance %}
    {%- else %}
        {%- set rdbd = 0 %}
    {%- endif %}
{%- else %}
    {%- set rdbd = 0 %}
{%- endif %}

{%- set DHLM = 0.0 %}
{%- set DLLM = 0.0 %}
{%- if (softlimits is defined) and (softlimits.enable is defined) and (softlimits.enable == true) %}
    {%- if (softlimits.forward is defined) and (softlimits.forwardEnable == true) %}
        {%- set DHLM = softlimits.forward %}
        epicsEnvSet(ECMC_MR_TEMP_FIELDS,"${ECMC_MR_TEMP_FIELDS=""}HLM={{ DHLM }},DHLM_En={{ softlimits.forwardEnable|int }},")
    {%- endif %}
    {%- if (softlimits.backward is defined) and (softlimits.backwardEnable == true) %}
        {%- set DLLM = softlimits.backward %}
        epicsEnvSet(ECMC_MR_TEMP_FIELDS,"${ECMC_MR_TEMP_FIELDS=""}LLM={{ DLLM }},DLLM_En={{ softlimits.backwardEnable|int}},")
    {%- endif %}
{%- endif %}

#- VMAX
{%- if monitoring.velocity is defined %}
    {%- if monitoring.velocity.enable|default(0)|int %}
        epicsEnvSet(ECMC_MR_TEMP_FIELDS,"${ECMC_MR_TEMP_FIELDS=""}VMAX={{ monitoring.velocity.max }},")
    {%- endif %}
{%- endif %}

#- Motor record controller params are scaled by a factor 0.01 (since they only allow a value 0..1)
epicsEnvSet(ECMC_MR_PCOF,0)
epicsEnvSet(ECMC_MR_ICOF,0)
epicsEnvSet(ECMC_MR_DCOF,0)

{%- if controller is defined %}
    {%- set controllerKp = controller.Kp|float %}
    {%- set controllerKi = controller.Ki|float %}
    {%- set controllerKd = controller.Kd|float %}
{% else %}
    {%- set controllerKp = 1.0 %}
    {%- set controllerKi = 0.0 %}
    {%- set controllerKd = 0.0 %}
{% endif %}

{%- if axis.type == 1 %}
    ecmcEpicsEnvSetCalc(ECMC_MR_PCOF,'clamp(0.0,{{ controllerKp }}/100.0,1.0)','%lf')
    ecmcEpicsEnvSetCalc(ECMC_MR_ICOF,'clamp(0,{{ controllerKi }}/100.0,1.0)','%lf')
    ecmcEpicsEnvSetCalc(ECMC_MR_DCOF,'clamp(0,{{ controllerKd }}/100.0,1.0)','%lf')
{% endif %}

{%- if drive is defined %}
    ecmcEpicsEnvSetCalc(ECMC_TEMP_SREV,'abs({{ drive.denominator|default(1)|int }})')
    ecmcEpicsEnvSetCalc(ECMC_TEMP_UREV,'abs({{ drive.numerator|default(1) }})')
{%- else %}
    ecmcEpicsEnvSetCalc(ECMC_TEMP_SREV,'abs(1)')
    ecmcEpicsEnvSetCalc(ECMC_TEMP_UREV,'abs(1)')
{%- endif %}

{%- if (epics is defined) and (epics.unit is defined) %}
    {%- set epicsUnit = epics.unit %}
{%- else %}
    {%- set epicsUnit = "mm" %}
{%- endif %}

{%- if (epics is defined) and (epics.precision is defined) %}
    {%- set epicsPrecision = epics.precision %}
{%- else %}
    {%- set epicsPrecision = 3 %}
{%- endif %}

{%- if (epics is defined) and (epics.motorRecord is defined) and (epics.motorRecord.description is defined) %}
    {%- set epicsmotorRecordDescription = epics.motorRecord.description %}
{%- else %}
    {%- set epicsmotorRecordDescription = "" %}
{%- endif %}

{%- if (epics is defined) and (epics.motorRecord is defined) and (epics.motorRecord.fieldInit is defined) %}
    {%- set epicsmotorRecordfieldInit = epics.motorRecord.fieldInit %}
{%- else %}
    {%- set epicsmotorRecordfieldInit = "" %}
{%- endif %}


ecmcFileExist(ecmcMotorRecord.template,1,1)
dbLoadRecords(ecmcMotorRecord.template,"PREFIX=${ECMC_PREFIX},MOTOR_NAME={{ epicsName }},MOTOR_PORT=${ECMC_MOTOR_PORT},ECMC_PORT=${ECMC_ASYN_PORT},AXIS_NO=${ECMC_AXIS_NO},DESC='{{ epicsmotorRecordDescription }}',EGU={{ epicsUnit }},PREC={{ epicsPrecision }},VELO={{ trajectory.axis.velocity }},JVEL={{ jogVelocity }},JAR={{ jogAcceleration }},ACCS={{ trajectory.axis.acceleration }},RDBD={{ rdbd }},DLLM={{ DLLM|float }},DHLM={{ DHLM|float }},SREV=$(ECMC_TEMP_SREV),UREV=$(ECMC_TEMP_UREV),TWV={{ axis.tweakDist|default(1.0)|float }},{{ epicsmotorRecordfieldInit }},${ECMC_MR_TEMP_FIELDS=""},PCOF=${ECMC_MR_PCOF},ICOF=${ECMC_MR_ICOF},DCOF=${ECMC_MR_DCOF},SYNC_DXLM={{ syncEcmcMRSofLim }}")
epicsEnvUnset(ECMC_TEMP_UREV)
epicsEnvUnset(ECMC_TEMP_SREV)
epicsEnvUnset(ECMC_MR_TEMP_FIELDS)
epicsEnvUnset(ECMC_MR_PCOF)
epicsEnvUnset(ECMC_MR_ICOF)
epicsEnvUnset(ECMC_MR_DCOF)

#- PVT
{%- if (epics is defined) and (epics.motorRecord is defined) and (epics.motorRecord.pvt is defined) %}

    {%- if epics.motorRecord.pvt.npoints is defined %}
        {%- set pvtNpoints = epics.motorRecord.pvt.npoints %}
    {%- else %}
        {%- set pvtNpoints = 0 %}
    {%- endif %}

    {%- if epics.motorRecord.pvt.nreadback is defined %}
        {%- set pvtNreadback = epics.motorRecord.pvt.nreadback %}
    {%- else %}
        {%- set pvtNreadback = 0 %}
    {%- endif %}

    epicsEnvSet(ECMC_MR_PVT_FIRST_AXIS_ID,${ECMC_MR_PVT_FIRST_AXIS_ID=${ECMC_AXIS_NO}})
    dbLoadRecords(ecmcProfileMoveAxis.template,"P=${ECMC_PREFIX},M={{ epicsName }}-PVT-,R=,PORT=${ECMC_MOTOR_PORT},ADDR=${ECMC_AXIS_NO},PREC={{ epicsPrecision }},NPOINTS={{ pvtNpoints }},NREADBACK={{ pvtNreadback }}")
    #- Enable PVT for axis
    ecmcEnablePVTForAxis(${ECMC_MOTOR_PORT},${ECMC_AXIS_NO},1)
    #- Save some vars for loading of ecmcProfileMoveController.template in setAppMode.cmd
    ecmcEpicsEnvSetCalcTernary(ECMC_MR_PVT_MAX_RB_POINTS_IN_USE,"${ECMC_MR_PVT_MAX_RB_POINTS_IN_USE=0}<{{ pvtNreadback }}",{{ pvtNreadback }} ,${ECMC_MR_PVT_MAX_RB_POINTS_IN_USE=0})
    ecmcEpicsEnvSetCalcTernary(ECMC_MR_PVT_MAX_POINTS_IN_USE,"${ECMC_MR_PVT_MAX_POINTS_IN_USE=0}<{{ pvtNpoints }}",{{ pvtNpoints }} ,${ECMC_MR_PVT_MAX_POINTS_IN_USE=0})
    ecmcEpicsEnvSetCalc(ECMC_MR_PVT_AXES_COUNT_IN_USE,"${ECMC_MR_PVT_AXES_COUNT_IN_USE=0}+1")
    #- Load cfg records for PVT axis (enable auto gui)
    dbLoadRecords(ecmcProfileMoveMCUAxis.template,"IOC=$(IOC),DEV=${DEV=$(IOC)},AXIS_NAME={{ epicsName }},PVT_AXIS_NO=$(ECMC_MR_PVT_AXES_COUNT_IN_USE),AXIS_NO=${ECMC_AXIS_NO}")
{%- endif %}

#- ############################################################################
#- Motor record: homing
#- ############################################################################
{%- if (homing is defined) and (encoder.homing is defined) %}
   # ERROR: Duplicate homing parameters identified (homing and encoder.homing)
   #        Homing parameters can only be defined at one place
   ecmcExit
{%- endif %}

{%- if (encoder.homing is defined) or (homing is defined) %}
    ecmcFileExist(ecmcMotorRecordhome.template,1,1)
    dbLoadRecords(ecmcMotorRecordhome.template, "PREFIX=${ECMC_PREFIX}, MOTOR_NAME='{{ epicsName }}', MOTOR_PORT=${ECMC_MOTOR_PORT}, AXIS_NO=${ECMC_AXIS_NO},HOMEPOS=${HOME_POS=0},HVELTO=${VEL_TO_CAM=0},HVELFRM=${VEL_FRM_CAM=0},HOMEACC=${ACC=0},HOMEDEC=${DEC=0}")
{%- endif %}
